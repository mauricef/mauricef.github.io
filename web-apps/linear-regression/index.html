<!DOCTYPE html>
<html>
    <head>
        <title>Small Things | Linear Regression</title>
        <style>
            .axis {
                stroke: lightgrey;
            }
            .pred {
                stroke: lightcoral;
            }
            .point {
                r: 1;
                fill: blue;
            }
        </style>
    </head>
    <body>
    </body>
    <script src="https://d3js.org/d3.v5.min.js"></script>
    <script src="https://d3js.org/d3-random.v2.min.js"></script>
    <script>
        const xs = d3.range(-100, 100, 10)
        const n = xs.length
        const epochs = 20
        const lm = .0001
        const lb = .1
        function initState() {
            const e = d3.randomNormal(0, 10)
            const m = d3.randomUniform(-2, 2)()
            const b = d3.randomUniform(-50, 50)()
            const ys = xs.map((x) => m * x + b + e())
            const points = d3.range(xs.length).map((i) => ({x: xs[i], y: ys[i]}))
            var mpred = 0
            var bpred = 0
            const pred = (x) => (x * mpred + bpred)
            function step() {
                const dm = (-2/n) * d3.sum(d3.range(n).map(i => xs[i] * (ys[i] - pred(xs[i]))))
                const db = (-2/n) * d3.sum(d3.range(n).map(i => ys[i] - pred(xs[i])))
                mpred = mpred - lm * dm
                bpred = bpred - lb * db
            }
            return {ys, points, step, pred}
        }
        function pointHtml({x, y}) {
            return `<circle class="point" cx="${x}"" cy="${y}"/>`
        }
        let epoch = 0
        let state
        setInterval(() => {
            if (epoch == epochs) {
                epoch = 0
                state = null
            }
            if (state == null) {
                state = initState()
            }
            epoch = epoch + 1
            const {ys, points, step, pred} = state
            document.body.innerHTML = `
                <svg viewBox="-100 -100 200 200">
                    <g transform="scale(1, -1)">
                        <line class="axis" y1="-100" y2="100"/>
                        <line class="axis" x1="-100" x2="100"/>
                        <line class="pred" x1="-100" y1="${pred(-100)}" 
                            x2="100" y2="${pred(100)}"/>
                        ${points.map(pointHtml)}
                    </g>
                </svg>
            `
            step()
        }, 100);
    </script>
</html>