<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Small Things | Cube Physics</title>
		<style>
      * {
        margin:0;
        padding:0
      }

      body {
        overflow:hidden;
      }
		</style>
	</head>
	<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/110/three.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/cannon.js/0.6.2/cannon.min.js"></script>
		<script>
      function initCannon() {
        var world = new CANNON.World();
        world.gravity.set(0, 0, -9.82);
        world.broadphase = new CANNON.NaiveBroadphase();

        var radius = 1
        var cubeMaterial = new CANNON.Material()
        var cubeBody = new CANNON.Body({
          angularVelocity: new CANNON.Vec3(
            Math.random(), Math.random(), Math.random()),
          mass: 5,
          position: new CANNON.Vec3(0, 0, 10),
          material: cubeMaterial,
          shape: new CANNON.Box(new CANNON.Vec3(2, 2, 2)),
          linearDamping: .1
        })
        world.addBody(cubeBody)


        var groundMaterial = new CANNON.Material()
        var groundShape = new CANNON.Plane()
        var groundBody = new CANNON.Body({ 
          position: new CANNON.Vec3(0, 0, -1),
          mass: 0, material: groundMaterial 
        });
        groundBody.addShape(groundShape);
        var contactMaterial = new CANNON.ContactMaterial(
          groundMaterial, cubeMaterial, 
          {restitution: .75, friction: .25})
        
        world.addBody(groundBody);
        world.addContactMaterial(contactMaterial)

        return {world, body: cubeBody}
      }
      
      function initThree() {
        var scene = new THREE.Scene();
        scene.background = new THREE.Color("white")
        
        var camera = new THREE.PerspectiveCamera(
          75, window.innerWidth / window.innerHeight, 1, 100);
        camera.position.x = 0;
        camera.position.y = 20;
        camera.position.z = 10;
        camera.lookAt(0, 0, 0);
        camera.rotateZ(Math.PI)
        scene.add(camera);

        var light = new THREE.AmbientLight("white")
        scene.add(light)
        
        var geo = new THREE.BoxGeometry(2, 2, 2);
        var mat = new THREE.MeshStandardMaterial( 
          { color: "gold" } );

        var mesh = new THREE.Mesh(geo, mat);
        mesh.castShadow = true;
        scene.add(mesh);

        var planeGeo = new THREE.PlaneGeometry(100, 100);
        var planMat = new THREE.MeshStandardMaterial(
          {color: "lightgrey", side: THREE.DoubleSide});
        var planeMesh = new THREE.Mesh(planeGeo, planMat);
        planeMesh.receiveShadow = true;
        scene.add(planeMesh);

        function addLight(x, y, z) {
          var l = new THREE.SpotLight(0xffffff, 1);
          l.castShadow = true;
//          l.target = mesh;   
          l.position.x = x;
          l.position.y = y;
          l.position.z = z;
          scene.add(l);
        }
        addLight(0, 0, 20);
        addLight(-5, 0, 4);
        
        var renderer = new THREE.WebGLRenderer({antialias: true});
        renderer.shadowMap.enabled = true;
        renderer.shadowMap.type = THREE.PCFSoftShadowMap; // default 
        renderer.setSize(window.innerWidth, window.innerHeight);
        document.body.appendChild(renderer.domElement);
        
        return {
          render: () => renderer.render(scene, camera),
          mesh: mesh
        }
      }
      
      function animate({world, body, render, mesh}) {
        var fixedTimeStep = 1.0 / 60;
        var maxSubSteps = 3;
        var lastTime;
        function simLoop(time){
          requestAnimationFrame(simLoop);
          if(lastTime !== undefined){
             var dt = (time - lastTime) / 1000;
             world.step(fixedTimeStep, dt, maxSubSteps);
          }
          mesh.position.copy(body.position);
          mesh.quaternion.copy(body.quaternion);
          render()
          lastTime = time;
        }
        simLoop()
      }
      
      function run() {
        var {world, body} = initCannon()
        var {render, mesh} = initThree()
        animate({world, body, render, mesh})
      }
      run()
      
//      
//      var mat1 = new CANNON.Material();
//      shapeBody1 = new CANNON.Body({
//          mass: mass,
//          material: mat1,
//          position: new CANNON.Vec3(0, 0, 0)
//      });
//      shapeBody1.addShape(sphereShape);
//      shapeBody1.linearDamping = damping;
//      world.addBody(shapeBody1);
//      var mat1_ground = new CANNON.ContactMaterial(
//        groundMaterial, mat1, 
//        { friction: 0.0, restitution: 0.5 });
//
//      world.addContactMaterial(mat1_ground);
// 
//
//      function initThree() {
//
//          scene = new THREE.Scene();
//          scene.background = new THREE.Color("white")
//        
//          camera = new THREE.PerspectiveCamera(
//            75, window.innerWidth / window.innerHeight, 1, 100 );
//          camera.position.x = 0;
//          camera.position.y = 0;
//          camera.position.z = 5;
//          scene.add(camera);
//
//          light = new THREE.AmbientLight("white")
//          scene.add(light)
//        
//          geometry = new THREE.SphereGeometry(1, 32, 32);
//          material = new THREE.MeshStandardMaterial( 
//            { color: "gold" } );
//
//          mesh = new THREE.Mesh( geometry, material );
//          scene.add( mesh );
//
//          renderer = new THREE.WebGLRenderer({antialias: true});
//          renderer.setSize(window.innerWidth, window.innerHeight);
//
//          document.body.appendChild(renderer.domElement);
//
//      }
//
//      function animate() {
//
//          requestAnimationFrame(animate);
//          updatePhysics();
//          render();
//
//      }
//
//      function updatePhysics() {
//
//          // Step the physics world
//          world.step(timeStep);
//
//          // Copy coordinates from Cannon.js to Three.js
//          mesh.position.copy(shapeBody1.position);
//          mesh.quaternion.copy(shapeBody1.quaternion);
//
//      }
//
//      function render() {
//
//          renderer.render( scene, camera );
//
//      }


		</script>
	</body>
</html>