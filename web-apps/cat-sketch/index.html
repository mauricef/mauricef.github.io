<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Cat Sketch</title>
		<style>
			body { margin: 0; }
			canvas { display: block; }
		</style>
	</head>
	<body>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.2/p5.min.js"></script>
    <script src="https://unpkg.com/ml5@0.4.3/dist/ml5.min.js"></script>
		<script>
      function randomColor() {
        return color(random(255), random(255), random(255))
      }
      
      class Sketch {
        constructor() {
          this.alpha = 255;
          this.pg = createGraphics(width, height)
          this.x = 0;
          this.y = 0;

          this.pg.translate(width/2, height/2)
          this.pg.stroke(randomColor())
          this.pg.strokeWeight(2)
        }
        
        draw(strokePath) {
          let newX = this.x + strokePath.dx;
          let newY = this.y + strokePath.dy;
          if (strokePath.pen == "down") {
            this.pg.line(this.x, this.y, newX, newY)
          }
          this.x = newX
          this.y = newY
        }
      }
      
      let loading = true;
      let sketch = null;
      let oldSketches = []
      let model;
      let strokePath;
      
      function setup() {
        createCanvas(windowWidth, windowHeight);
        model = ml5.sketchRNN("cat", onModelReady);
      }

      function draw() {
        background("white")
        if (loading) {
          fill(randomColor())
          text('Loading Cat Brain', width/2, height/2)
        }
        else if (strokePath != null) {  
          for (os of oldSketches.slice()) {
              tint(255, os.alpha)
              image(os.pg, 0, 0)
          }
          tint(255, 255)
          image(sketch.pg, 0, 0)
        }
      }

      function onModelReady() {
        loading = false
        onNewSketch()
        noLoop()
      }

      function onNewSketch(){
        if (sketch != null) {          
          oldSketches.unshift(sketch)
        }
        sketch = new Sketch()
        model.reset();
        model.generate(onGenerate);
      }
      
      function onGenerate(error, sp) {
        if (error) {
          console.error(error);
        } else {
          strokePath = sp
          sketch.draw(strokePath)
          redraw()
          for (os of oldSketches.slice()) {
            if (os.alpha <= 0) {
              os.pg.remove()
              oldSketches.pop()
            }
            else {
              os.alpha -= 10
            }
          }
          redraw()
          if (strokePath.pen == "end") {
            onNewSketch()
          }
          else {
            setTimeout(()=> model.generate(onGenerate), 10)            
          }
        }
      }
		</script>
	</body>
</html>